<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title data-i18n="title">Electricity Bill Calculator</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="favicon.ico">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="EVN Bill Calculator">
    <meta name="apple-mobile-web-app-title" content="EVN Bill Calculator">
    <meta name="theme-color" content="#e74c3c">
    <meta name="msapplication-navbutton-color" content="#e74c3c">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        /* Base styles */
        :root {
            --main-padding: 16px;
            --border-radius: 8px;
            --shadow: 0 2px 10px rgba(0,0,0,0.06);
            --primary-color: #e74c3c;
            --primary-hover: #c0392b;
            --text-color: #2c3e50;
            --border-color: #ddd;
            --background-light: #f8f9fa;
            --info-background: #e8f5e9;
            --total-background: #e8f4fc;
        }

        /* Reset and base styles */
        * { box-sizing: border-box; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
            margin: 0;
            padding: var(--main-padding);
            background: var(--background-light);
            color: var(--text-color);
            -webkit-font-smoothing: antialiased;
            line-height: 1.4;
        }

        /* Layout containers */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 var(--main-padding);
        }

        header { 
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        /* Typography */
        h1 { 
            margin: 0;
            font-size: clamp(1.25rem, 4vw, 1.5rem);
            line-height: 1.2;
        }

        /* Form elements */
        form {
            background: white;
            padding: var(--main-padding);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }

        .form-row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-group {
            flex: 1;
            min-width: 0; /* Prevents flex items from overflowing */
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }

        input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 16px; /* Prevents zoom on iOS */
            appearance: none; /* Removes default styling */
            -webkit-appearance: none;
        }

        input[type="date"] {
            min-height: 44px; /* Better touch target on mobile */
        }

        /* Controls and buttons */
        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .lang-select {
            padding: 8px 12px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            background: white;
            font-size: 16px;
            min-height: 44px; /* Better touch target */
        }

        button {
            width: 100%;
            padding: 14px 24px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
            min-height: 44px; /* Better touch target */
        }

        button:hover {
            background: var(--primary-hover);
        }

        /* Results section */
        #result {
            background: white;
            padding: var(--main-padding);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow-x: auto; /* Enables horizontal scroll on mobile */
            -webkit-overflow-scrolling: touch; /* Smooth scroll on iOS */
        }

        /* Table styles */
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 16px;
            font-size: 0.95rem;
        }

        th, td {
            border: 1px solid var(--border-color);
            padding: 12px 8px;
            text-align: left;
        }

        th {
            background: var(--background-light);
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .total {
            font-weight: bold;
            background: var(--total-background) !important;
        }

        /* Info boxes and utilities */
        .info {
            background: var(--info-background);
            padding: 16px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            font-size: 0.95rem;
        }

        .small {
            font-size: 0.9rem;
            color: #666;
            margin-top: 8px;
        }

        footer {
            margin-top: 24px;
            font-size: 0.85rem;
            color: #666;
            text-align: center;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            body {
                padding: 12px;
            }

            .container {
                padding: 0;
            }

            header {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            .controls {
                flex-direction: column;
            }

            .form-row {
                flex-direction: column;
                gap: 12px;
            }

            table {
                font-size: 0.9rem;
            }

            th, td {
                padding: 10px 6px;
            }
        }

        /* iOS specific optimizations */
        @supports (-webkit-touch-callout: none) {
            input, select, button {
                font-size: 16px !important; /* Prevents zoom on iOS */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1 data-i18n="title">Electricity Bill Calculator</h1>
                <div class="small" data-i18n="subtitle">Based on EVN North Macedonia invoice structure</div>
            </div>
            <div class="controls">
                <label for="lang" style="margin:0;font-weight:600;" data-i18n="language">Language</label>
                <select id="lang" class="lang-select" aria-label="language selector">
                    <option value="sq">Shqip (Albanian)</option>
                    <option value="en">English</option>
                    <option value="mk">Македонски (Macedonian)</option>
                </select>
            </div>
        </header>

        <main>
            <div class="info" id="intro">
                <strong data-i18n="info_title">Based on the EVN North Macedonia invoice structure</strong><br>
                <span data-i18n="info_text">This calculator uses tariff blocks that adjust based on the number of days between meter readings. The low tariff is billed as recorded on the invoice.</span>
                <div class="small" style="margin-top:8px;">
                    <a id="docsLink" href="docs.html" data-i18n="docs_link">How the measurement is taken (docs)</a>
                </div>
            </div>
            
            <div class="form-group" style="margin-bottom:20px;">
                <label for="history" data-i18n="history">Previous calculations:</label>
                <div id="historyContainer" style="display:flex;align-items:center;">
                    <select id="history" class="lang-select" style="width:calc(100% - 30px);">
                        <option value="" data-i18n="history_none">No previous calculations</option>
                    </select>
                </div>
            </div>

            <form id="calcForm" aria-labelledby="calcForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="prevDate" data-i18n="prevDate">Previous reading date:</label>
                        <input type="date" id="prevDate" required>
                    </div>
                    <div class="form-group">
                        <label for="currDate" data-i18n="currDate">Current reading date:</label>
                        <input type="date" id="currDate" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="prevHigh" data-i18n="prevHigh">Previous month reading (high tariff):</label>
                    <input type="number" id="prevHigh" required value="28157" inputmode="decimal">
                </div>

                <div class="form-group">
                    <label for="prevLow" data-i18n="prevLow">Previous month reading (low tariff):</label>
                    <input type="number" id="prevLow" required value="26713" inputmode="decimal">
                </div>

                <div class="form-group">
                    <label for="currHigh" data-i18n="currHigh">Current month reading (high tariff):</label>
                    <input type="number" id="currHigh" required value="28728" inputmode="decimal">
                </div>

                <div class="form-group">
                    <label for="currLow" data-i18n="currLow">Current month reading (low tariff):</label>
                    <input type="number" id="currLow" required value="27319" inputmode="decimal">
                </div>

                <button type="submit" id="calcBtn" data-i18n="calcBtn">Calculate bill</button>
            </form>

            <div id="result" aria-live="polite"></div>
        </main>

    <footer>

    <footer>
        <div class="small" data-i18n="footer_note">You can host this page as index.html on GitHub Pages. Language preference is saved in local storage.</div>
    </footer>

    <script>
        // --- Translations ---
        const i18n = {
            en: {
                title: "Electricity Bill Calculator",
                subtitle: "Based on EVN North Macedonia invoice structure",
                language: "Language",
                history: "Previous calculations:",
                history_none: "No previous calculations",
                history_option: "{month} (prev: {prevDate}, curr: {currDate})",
                months: ["January", "February", "March", "April", "May", "June", 
                        "July", "August", "September", "October", "November", "December"],
                info_title: "Based on the EVN North Macedonia invoice structure",
                info_text: "This calculator uses tariff blocks that adjust based on the number of days between meter readings. The low tariff is billed as recorded on the invoice.",
                docs_link: "How the measurement is taken (docs)",
                prevDate: "Previous reading date:",
                currDate: "Current reading date:",
                prevHigh: "Previous month reading (high tariff):",
                prevLow: "Previous month reading (low tariff):",
                currHigh: "Current month reading (high tariff):",
                currLow: "Current month reading (low tariff):",
                calcBtn: "Calculate bill",
                results: "Calculation results",
                highConsumption: "High-tariff consumption",
                lowConsumption: "Low-tariff consumption",
                billedLow: "billed as recorded",
                totalConsumption: "Total consumption",
                desc: "Description",
                kWh: "kWh",
                price: "Price (MKD/kWh)",
                amount: "Amount (MKD)",
                block1: "Block 1",
                block2: "Block 2",
                block3: "Block 3",
                block4: "Block 4",
                lowTariff: "Low tariff",
                transmission: "Energy transmission",
                accessFee: "Access fee (fixed)",
                subtotal: "Subtotal before VAT",
                vat: "VAT (18%)",
                otherTax: "Service tax",
                totalPay: "TOTAL TO PAY",
                footer_note: "Contact albin.abduli@live.com for improvements or suggestions."
            },
            sq: {
                title: "Llogaritës i Faturës së Energjisë Elektrike",
                subtitle: "Bazuar në strukturën e faturës së EVN Maqedoni e Veriut",
                language: "Gjuha",
                history: "Llogaritjet e mëparshme:",
                history_none: "Nuk ka llogaritje të mëparshme",
                history_option: "{month} (para: {prevDate}, tani: {currDate})",
                months: ["Janar", "Shkurt", "Mars", "Prill", "Maj", "Qershor", 
                        "Korrik", "Gusht", "Shtator", "Tetor", "Nëntor", "Dhjetor"],
                info_title: "Bazuar në strukturën e faturës së EVN Maqedoni e Veriut",
                info_text: "Ky llogaritës përdor blloqe tarifore që përshtaten bazuar në numrin e ditëve midis leximeve të matësit. Tarifa e lirë paguhet sipas asaj që është faturuar në faturë.",
                docs_link: "Si matet konsumimi (dokumentacion)",
                prevDate: "Data e leximit të mëparshëm:",
                currDate: "Data e leximit aktual:",
                prevHigh: "Leximi i muajit të kaluar (e shtrejtë):",
                prevLow: "Leximi i muajit të kaluar (e lirë):",
                currHigh: "Leximi i këtij muaji (e shtrejtë):",
                currLow: "Leximi i këtij muaji (e lirë):",
                calcBtn: "Llogarit Faturën",
                results: "Rezultatet e Llogaritjes",
                highConsumption: "Konsumi i tarifës së shtrenjtë",
                lowConsumption: "Konsumi i tarifës së lirë",
                billedLow: "e faturuar sipas regjistrimit",
                totalConsumption: "Totali i konsumit",
                desc: "Përshkrim",
                kWh: "kWh",
                price: "Çmimi (denarë/kWh)",
                amount: "Shuma (denarë)",
                block1: "Blloku 1 (0–210 kWh)",
                block2: "Blloku 2 (210–630 kWh)",
                block3: "Blloku 3 (630–1050 kWh)",
                block4: "Blloku 4 (>1050 kWh)",
                lowTariff: "Tarifa e lirë",
                transmission: "Transmetimi i energjisë",
                accessFee: "Taksa e qasjes (fiks)",
                subtotal: "Nën-totali para TVSH",
                vat: "TVSH (18%)",
                otherTax: "Taksa për shërbime",
                totalPay: "TOTAL PËR TË PAGUAR",
                footer_note: "Kontaktoni albin.abduli@live.com për përmirësime ose sugjerime."
            },
            mk: {
                title: "Калкулатор за сметка за електрична енергија",
                subtitle: "Врз основа на структурата на фактурата од EVN Северна Македонија",
                language: "Јазик",
                history: "Претходни пресметки:",
                history_none: "Нема претходни пресметки",
                history_option: "{month} (пред: {prevDate}, сега: {currDate})",
                months: ["Јануари", "Февруари", "Март", "Април", "Мај", "Јуни", 
                        "Јули", "Август", "Септември", "Октомври", "Ноември", "Декември"],
                info_title: "Врз основа на структурата на фактурата од EVN Северна Македонија",
                info_text: "Овој калкулатор користи тарифни блокови кои се прилагодуваат врз основа на бројот на денови помеѓу читањата на броилото. Евтината тарифа е фактурирана според вредностите на фактурата.",
                docs_link: "Како се мери (документација)",
                prevDate: "Датум на претходно читање:",
                currDate: "Датум на тековно читање:",
                prevHigh: "Претходно месечно читање (скапо):",
                prevLow: "Претходно месечно читање (евтино):",
                currHigh: "Тековно читање (скапо):",
                currLow: "Тековно читање (евтино):",
                calcBtn: "Пресметај сметка",
                results: "Резултати од пресметката",
                highConsumption: "Потрошувачка на скапа тарифа",
                lowConsumption: "Потрошувачка на евтина тарифа",
                billedLow: "фактурирано според записот",
                totalConsumption: "Вкупна потрошувачка",
                desc: "Опис",
                kWh: "kWh",
                price: "Цена (ден/kWh)",
                amount: "Сума (денари)",
                block1: "Блок 1 (0–210 kWh)",
                block2: "Блок 2 (210–630 kWh)",
                block3: "Блок 3 (630–1050 kWh)",
                block4: "Блок 4 (>1050 kWh)",
                lowTariff: "Евтина тарифа",
                transmission: "Трансмисија на енергија",
                accessFee: "Такса за пристап (фиксна)",
                subtotal: "Вкупно пред ДДВ",
                vat: "ДДВ (18%)",
                otherTax: "Такса за услуги",
                totalPay: "ВКУПНО ЗА ПЛАЌАЊЕ",
                footer_note: "Контактирајте albin.abduli@live.com за подобрувања или предлози."
            }
        };

        // --- Calculation history management ---
        const HISTORY_KEY = 'gcc_history';
        
        // Load calculations from localStorage
        const loadHistory = () => {
            try {
                return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
            } catch (e) {
                return [];
            }
        };

        // Get month with most days in the reading period
        const getDominantMonth = (prevDate, currDate) => {
            const start = new Date(prevDate);
            const end = new Date(currDate);
            
            // Create array of days per month in period
            const daysInMonth = new Array(12).fill(0);
            const current = new Date(start);
            
            while (current <= end) {
                daysInMonth[current.getMonth()]++;
                current.setDate(current.getDate() + 1);
            }
            
            // Find month with most days
            const maxDays = Math.max(...daysInMonth);
            const dominantMonthIndex = daysInMonth.indexOf(maxDays);
            
            return dominantMonthIndex; // Return just the month index (0-11)
        };

        // Check if calculation with same dates exists
        const isDuplicateCalculation = (calc, history) => {
            return history.some(h => 
                h.prevDate === calc.prevDate && 
                h.currDate === calc.currDate && 
                h.prevHigh === calc.prevHigh && 
                h.prevLow === calc.prevLow && 
                h.currHigh === calc.currHigh && 
                h.currLow === calc.currLow
            );
        };

        // Save a calculation to history
        const saveToHistory = (calc) => {
            const history = loadHistory();
            
            // Don't save if duplicate
            if (isDuplicateCalculation(calc, history)) return;
            
            // Add dominant month to calculation
            calc.dominantMonth = getDominantMonth(calc.prevDate, calc.currDate);
            
            history.unshift(calc); // Add to start
            // Keep last 100 calculations
            if (history.length > 100) history.length = 100;
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            updateHistoryDropdown();
        };

        // Delete a calculation from history
        const deleteCalculation = (idx) => {
            const history = loadHistory();
            history.splice(idx, 1);
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            updateHistoryDropdown();
            // Clear form if the current calculation was deleted
            if (idx === parseInt(document.getElementById('history').value)) {
                document.getElementById('history').value = '';
                document.getElementById('result').innerHTML = '';
            }
        };

        // Format a date for display in dd/mm/yyyy format
        const formatDate = (date) => {
            const d = new Date(date);
            return `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getFullYear()}`;
        };

        // Update the history dropdown with saved calculations
        const updateHistoryDropdown = () => {
            const history = loadHistory();
            const select = document.getElementById('history');
            const lang = document.documentElement.lang;
            const t = i18n[lang] || i18n.sq;
            
            // Create a container for the dropdown and delete buttons
            const container = document.getElementById('historyContainer');
            container.innerHTML = ''; // Clear existing content
            
            // Recreate the select element
            const newSelect = document.createElement('select');
            newSelect.id = 'history';
            newSelect.className = 'lang-select';
            newSelect.style.width = 'calc(100% - 30px)'; // Make room for delete button
            
            // Add empty option
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = t[history.length ? 'history_option_select' : 'history_none'];
            newSelect.appendChild(emptyOption);

            // Add calculations as options
            history.forEach((calc, idx) => {
                const option = document.createElement('option');
                option.value = idx;
                const t = i18n[lang] || i18n.sq;
                const label = t.history_option
                    .replace('{month}', t.months[calc.dominantMonth])
                    .replace('{prevDate}', formatDate(calc.prevDate))
                    .replace('{currDate}', formatDate(calc.currDate));
                option.textContent = label;
                newSelect.appendChild(option);
                
                // Create delete button container
                const buttonContainer = document.createElement('div');
                buttonContainer.style.display = 'none';
                buttonContainer.style.marginLeft = '8px';
                buttonContainer.innerHTML = `<button onclick="deleteCalculation(${idx})" style="width:auto;padding:4px 8px;min-height:30px;">✕</button>`;
                container.appendChild(buttonContainer);
            });
            
            // Add select to container
            container.insertBefore(newSelect, container.firstChild);
            
            // Setup change handler for showing/hiding delete buttons and loading calculation
            newSelect.addEventListener('change', function(e) {
                const idx = parseInt(e.target.value);
                // Show/hide delete buttons
                const buttons = container.querySelectorAll('div');
                buttons.forEach((btn, i) => {
                    btn.style.display = i === idx ? 'inline-block' : 'none';
                });
                
                // Load calculation data
                if (!isNaN(idx)) {
                    const history = loadHistory();
                    if (idx >= 0 && idx < history.length) {
                        loadCalculation(history[idx]);
                        // Trigger form submission to show results
                        document.getElementById('calcForm').dispatchEvent(new Event('submit'));
                    }
                }
            });
        };

        // Load calculation into form
        const loadCalculation = (calc) => {
            document.getElementById('prevDate').value = calc.prevDate;
            document.getElementById('currDate').value = calc.currDate;
            document.getElementById('prevHigh').value = calc.prevHigh;
            document.getElementById('prevLow').value = calc.prevLow;
            document.getElementById('currHigh').value = calc.currHigh;
            document.getElementById('currLow').value = calc.currLow;
        };

        // Auto-fill from last calculation if 28+ days passed
        const autoFillFromLast = () => {
            const history = loadHistory();
            if (history.length === 0) return;
            
            const lastCalc = history[0];
            const lastDate = new Date(lastCalc.currDate);
            const today = new Date();
            const daysPassed = Math.round((today - lastDate) / (1000 * 60 * 60 * 24));
            
            if (daysPassed >= 28) {
                // Use last current readings as new previous readings
                document.getElementById('prevDate').value = lastCalc.currDate;
                document.getElementById('currDate').value = today.toISOString().split('T')[0];
                document.getElementById('prevHigh').value = lastCalc.currHigh;
                document.getElementById('prevLow').value = lastCalc.currLow;
                document.getElementById('currHigh').value = '';
                document.getElementById('currLow').value = '';
            }
        };

        // --- Helpers for i18n ---
        const applyTranslations = (lang) => {
            document.documentElement.lang = lang;
            const dict = i18n[lang] || i18n.sq;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (!key) return;
                // preserve innerHTML if translation contains markup
                if (dict[key]) {
                    el.innerHTML = dict[key];
                }
            });
            // Update title separately
            if (dict.title) document.title = dict.title;
            // Update history dropdown with new language
            updateHistoryDropdown();
        };

        // --- Save/load language preference ---
        const LANG_KEY = 'gcc_lang';
        const langSelect = document.getElementById('lang');
        const saved = localStorage.getItem(LANG_KEY) || navigator.language?.slice(0,2) || 'en';
        // normalize
        const normalized = ['en','sq','mk'].includes(saved) ? saved : (saved === 'en' ? 'en' : (saved === 'mk' ? 'mk' : 'sq'));
        langSelect.value = normalized;
        applyTranslations(normalized);

        langSelect.addEventListener('change', () => {
            const v = langSelect.value;
            localStorage.setItem(LANG_KEY, v);
            applyTranslations(v);
        });

        // --- Calculation logic (same as original, with translated output) ---

        // Initial setup
        document.addEventListener('DOMContentLoaded', function() {
            updateHistoryDropdown();
            autoFillFromLast();
        });

        document.getElementById('calcForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const lang = localStorage.getItem(LANG_KEY) || 'en';
            const t = i18n[lang];

            // Get form values for saving
            const formData = {
                calcDate: new Date().toISOString(),
                prevDate: document.getElementById('prevDate').value,
                currDate: document.getElementById('currDate').value,
                prevHigh: document.getElementById('prevHigh').value,
                prevLow: document.getElementById('prevLow').value,
                currHigh: document.getElementById('currHigh').value,
                currLow: document.getElementById('currLow').value
            };

            // Readings
            const prevHigh = parseFloat(document.getElementById('prevHigh').value) || 0;
            const prevLow = parseFloat(document.getElementById('prevLow').value) || 0;
            const currHigh = parseFloat(document.getElementById('currHigh').value) || 0;
            const currLow = parseFloat(document.getElementById('currLow').value) || 0;

            // Differences
            const diffHigh = currHigh - prevHigh;
            const diffLow = currLow - prevLow;

            // Constants (from XLSX)
            const rateBlok1 = 4.4376;
            const rateBlok2 = 5.5664;
            const rateBlok3 = 7.4314;
            const rateBlok4 = 18.3035;
            const rateLow = 1.9765;
            const transRate = 2.1418;
            const accessFee = 200;
            const vatRate = 0.18;
            const otherTax = 184;

            // Get dates and calculate days
            const prevDate = new Date(document.getElementById('prevDate').value);
            const currDate = new Date(document.getElementById('currDate').value);
            const days = Math.round((currDate - prevDate) / (1000 * 60 * 60 * 24));

            // Daily block rates (based on 30-day standard)
            const dailyBlock1 = 7;  // 210/30
            const dailyBlock2 = 14; // 420/30
            const dailyBlock3 = 14; // 420/30

            // Adjust block thresholds based on actual days
            const block1Threshold = Math.round(dailyBlock1 * days);
            const block2Threshold = Math.round(dailyBlock2 * days);
            const block3Threshold = Math.round(dailyBlock3 * days);

            // High tariff blocks with adjusted thresholds
            let blok1 = Math.min(Math.max(diffHigh, 0), block1Threshold);
            let cost1 = blok1 * rateBlok1;

            let remaining = diffHigh - block1Threshold;
            let blok2 = Math.min(Math.max(remaining, 0), block2Threshold);
            let cost2 = blok2 * rateBlok2;

            remaining -= blok2;
            let blok3 = Math.min(Math.max(remaining, 0), block3Threshold);
            let cost3 = blok3 * rateBlok3;

            let blok4 = Math.max(remaining - 420, 0);
            let cost4 = blok4 * rateBlok4;

            const highCost = cost1 + cost2 + cost3 + cost4;

            // Low tariff
            const lowCost = diffLow * rateLow;

            // Total kWh
            const totalKWh = Math.max(diffHigh,0) + Math.max(diffLow,0);

            // Transmission
            const transCost = totalKWh * transRate;

            // Subtotal before VAT
            const subtotal = highCost + lowCost + transCost + accessFee;

            // VAT 18%
            const vat = subtotal * vatRate;

            // Total final
            const total = subtotal + vat + otherTax;

            // Build results with translations
            const nf = new Intl.NumberFormat('en-US', { maximumFractionDigits: 4 });
            const nf2 = new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            let html = `<h2>${t.results}</h2>
                <p><strong>${t.highConsumption}:</strong> ${diffHigh} ${t.kWh || 'kWh'}</p>
                <p><strong>${t.lowConsumption}:</strong> ${diffLow} ${t.kWh || 'kWh'} (${t.billedLow})</p>
                <p><strong>${t.totalConsumption}:</strong> ${totalKWh} ${t.kWh || 'kWh'}</p>
                <table>
                    <tr><th>${t.desc}</th><th>${t.kWh}</th><th>${t.price}</th><th>${t.amount}</th></tr>
                    <tr><td>${t.block1} (0–${block1Threshold} kWh)</td><td>${blok1}</td><td>${rateBlok1}</td><td>${nf.format(cost1)}</td></tr>
                    <tr><td>${t.block2} (${block1Threshold+1}–${block1Threshold+block2Threshold} kWh)</td><td>${blok2}</td><td>${rateBlok2}</td><td>${nf.format(cost2)}</td></tr>
                    <tr><td>${t.block3} (${block1Threshold+block2Threshold+1}–${block1Threshold+block2Threshold+block3Threshold} kWh)</td><td>${blok3}</td><td>${rateBlok3}</td><td>${nf.format(cost3)}</td></tr>
                    <tr><td>${t.block4} (>${block1Threshold+block2Threshold+block3Threshold} kWh)</td><td>${blok4}</td><td>${rateBlok4}</td><td>${nf.format(cost4)}</td></tr>
                    <tr><td>${t.lowTariff}</td><td>${diffLow}</td><td>${rateLow}</td><td>${nf.format(lowCost)}</td></tr>
                    <tr><td>${t.transmission}</td><td>${totalKWh}</td><td>${transRate}</td><td>${nf.format(transCost)}</td></tr>
                    <tr><td>${t.accessFee}</td><td>-</td><td>-</td><td>${nf2.format(accessFee)}</td></tr>
                    <tr><td><strong>${t.subtotal}</strong></td><td>-</td><td>-</td><td><strong>${nf.format(subtotal)}</strong></td></tr>
                    <tr><td>${t.vat}</td><td>-</td><td>-</td><td>${nf.format(vat)}</td></tr>
                    <tr><td>${t.otherTax}</td><td>-</td><td>-</td><td>${nf2.format(otherTax)}</td></tr>
                    <tr class="total"><td><strong>${t.totalPay}</strong></td><td>-</td><td>-</td><td><strong>${nf2.format(total)}</strong> denarë</td></tr>
                </table>`;

            document.getElementById('result').innerHTML = html;
            
            // Save calculation to history
            saveToHistory(formData);
        });

        // Ensure docs link keeps language preference
        document.getElementById('docsLink').addEventListener('click', function(e){
            // keep normal navigation (docs.html will read localStorage)
        });
    </script>
</body>
</html>
